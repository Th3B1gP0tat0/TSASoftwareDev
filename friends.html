<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Friends</title>
    <link rel="stylesheet" href="stylesheet.css" />
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
      const supabaseUrl = "https://gcrezomlzfcymopehdhu.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjcmV6b21semZjeW1vcGVoZGh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI0MjE1MjMsImV4cCI6MjA1Nzk5NzUyM30.mwqO1LaHtSy4dLg0U-YqY1yjNLms4QFjcY6k689eBZY";
      window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-SLWY32DMJJ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-SLWY32DMJJ");
    </script>
  </head>
  <body style="background-color: #000">
    <header
      style="
        font-family: 'Montserrat', sans-serif;
        background-color: #252a49;
        padding: 10px 0;
      "
    >
      <div style="text-align: center; margin-top: 20px">
        <h1
          style="
            color: #14c46f;
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
          "
        >
          EcoTrack
        </h1>
      </div>
    </header>
    <header style="background-color: rgb(49, 54, 78)">
      <nav>
        <ul
          class="nav-list"
          style="display: flex; list-style: none; padding: 10px; margin: 10px 5"
        >
          <li class="nav-item" style="margin: 5 20px">
            <a
              href="homepage.html"
              class="nav-link"
              style="color: #f0f1de; text-decoration: none; font-size: 1rem"
              >Home</a
            >
          </li>
          <li class="nav-item" style="margin: 5 20px">
            <a
              href="stats.html"
              class="nav-link"
              style="color: #f0f1de; text-decoration: none; font-size: 1rem"
              >Your Statistics</a
            >
          </li>
          <li class="nav-item" style="margin: 5 20px">
            <a
              href="leaderboard.html"
              class="nav-link"
              style="color: #f0f1de; text-decoration: none; font-size: 1rem"
              >Community Leaderboard</a
            >
          </li>
          <li class="nav-item" style="margin: 5 20px">
            <a
              href="friends.html"
              class="nav-link"
              style="color: #f0f1de; text-decoration: none; font-size: 1rem"
              >Friends</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <h2 style="color: AntiqueWhite; margin-top: 20px; margin-left: 30px">
      <b>Community Leaderboard</b>
    </h2>

    <div id="root"></div>

    <script type="text/babel">
      async function fetchUserData() {
        try {
          const { data, error } = await window.supabase
            .from("user_data")
            .select("name, april");

          if (error) {
            console.error("Supabase error fetching data:", error);
            return [];
          }

          return data || [];
        } catch (err) {
          console.error("Unexpected error:", err);
          return [];
        }
      }

      function sortWithOriginalIndices(array) {
        const indexedArray = array.map((value, index) => ({ value, index }));
        indexedArray.sort((a, b) => a.value - b.value);
        const sortedValues = indexedArray.map((item) => item.value);
        const originalIndices = indexedArray.map((item) => item.index);
        return { sortedValues, originalIndices };
      }

      function LeaderboardTable({ nameslist, usagelist }) {
        return (
          <table style={{ color: "white" }}>
            <thead>
              <tr>
                <th>Name</th>
                <th>April Usage (kWH)</th>
              </tr>
            </thead>
            <tbody>
              {nameslist.map((name, idx) => (
                <tr key={idx}>
                  <td>{name}</td>
                  <td>{usagelist[idx]}</td>
                </tr>
              ))}
            </tbody>
          </table>
        );
      }

      async function init() {
        const rootElem = document.getElementById("root");
        const reactRoot = ReactDOM.createRoot(rootElem);
        const data = await fetchUserData();
        const names = data.map((d) => d.name);
        const usages = data.map((d) => d.april || 0);
        const { sortedValues, originalIndices } =
          sortWithOriginalIndices(usages);
        const sortedNames = originalIndices.map((i) => names[i]);

        reactRoot.render(
          <LeaderboardTable nameslist={sortedNames} usagelist={sortedValues} />
        );
      }

      init();
    </script>
  </body>
</html>
